# Category-Specific Configuration for DRY Category
# This file overrides base config.yaml settings for DRY category training

# Window configuration - DRY needs longer lookback for weekly stability
window:
  input_size: 28  # 28-day lookback for weekly pattern stability
  horizon: 30      # 30-day forecast horizon

# Model Configuration - DRY-specific architecture
model:
  hidden_size: 128
  n_layers: 2
  dropout_prob: 0.1  # Lower dropout for stable patterns
  use_layer_norm: true

# Training Configuration - Lower learning rate for stability
training:
  batch_size: 64
  epochs: 50  # Reduced from 100 to 50 for faster iteration
  learning_rate: 0.0005  # Lower LR for smooth convergence
  weight_decay: 1e-5     # Light regularization
  scheduler:
    patience: 8  # Moderate patience
    factor: 0.5

# Category-specific loss weighting
category_specific_params:
  DRY:
    learning_rate: 0.0005
    weight_decay: 1e-5
    patience: 5
    loss_weight: 1.0  # Standard weight for stable category
    
    # BALANCED DISTRIBUTION MODE: Eliminates upward bias while maintaining spike protection
    # This mode shifts from "Peak-Defense" to "Balanced Distribution" focus
    # Key benefits:
    #   - Eliminates persistent over-prediction in early month (Days 1-5)
    #   - Maintains spike protection during actual high-volume periods
    #   - Forces monthly totals to align with historical averages
    
    # Weekday Loss Weights: Emphasize high-volume days (Wednesday and Friday)
    monday_loss_weight: 3.0      # 3x weight on Monday (standard)
    wednesday_loss_weight: 4.0   # 4x weight on Wednesday (high-volume day) - REDUCED from 5x
    friday_loss_weight: 4.0      # 4x weight on Friday (high-volume day) - REDUCED from 5x
    # Rationale: 4x weight (reduced from 5x) provides weekday emphasis without over-penalizing
    # This captures the weekly pattern while avoiding excessive under-prediction
    
    # Asymmetric Penalty: Over-predictions penalized more heavily in non-peak periods
    use_asymmetric_penalty: true  # Enable asymmetric penalty for balanced distribution
    over_pred_penalty: 2.0  # 2.0x penalty for over-prediction in non-peak periods (REDUCED from 3.0)
    under_pred_penalty: 1.0  # 1.0x penalty for under-prediction (standard)
    # Rationale: 2.0x ratio (reduced from 3.0) provides bias correction without causing severe under-prediction
    # This balances early month suppression with overall volume accuracy
    
    # Mean Error Constraint: Forces monthly predictions to align with historical averages
    apply_mean_error_constraint: true  # Enable mean error constraint
    mean_error_weight: 0.10  # 0.10 weight for mean error constraint (REDUCED from 0.20)
    # Rationale: 0.10 weight (reduced from 0.20) provides gentle bias correction without over-constraining
    # This allows the model more flexibility to match actual volume levels
    
    # SOLUTION 2: Dynamic Early Month Loss Weighting - HARD RESET STRATEGY V2 (BALANCED)
    # Dynamic schedule (EXPONENTIAL DECAY - BALANCED for weekday patterns):
    #   - Days 1-5: 30x (REDUCED from 50x to reduce under-prediction while maintaining early month suppression)
    #   - Days 6-10: Exponential decay from 30x to 1x
    #   - Days 11+: 1x
    # This maintains early month low-volume focus while allowing sufficient overall prediction volume
    # The reduced weight (30x vs 50x/100x) allows better balance between early month suppression and volume accuracy
    # Combined with gentler asymmetric penalty (2x) and mean error constraint (0.10), this achieves:
    #   - Days 1-5 remain lower than rest of month ✓
    #   - Wednesday/Friday show weekly pattern ✓
    #   - Overall monthly volume matches actuals ✓
    use_dynamic_early_month_weight: true  # Enable gradient-based HARD RESET V2 penalty schedule
    dynamic_early_month_base_weight: 30.0  # Base weight for Days 1-5 (REDUCED from 50x to 30x for better balance)
    # Legacy static mode (commented out - use dynamic mode instead):
    # early_month_loss_weight: 15.0  # 15x weight on early month days (days 1-10) - STATIC MODE

# Seasonal configuration - DRY is not seasonal
data:
  seasonal_active_window: null  # No seasonal masking for DRY
  peak_event: null  # No peak event countdown

  feature_cols:
    - "month_sin"
    - "month_cos"
    - "dayofmonth_sin"
    - "dayofmonth_cos"
    - "holiday_indicator"
    - "days_until_next_holiday"
    - "days_since_holiday"
    - "is_weekend"
    - "day_of_week_sin"
    - "day_of_week_cos"
    - "weekday_volume_tier"        # CRITICAL: Strong Mon/Wed/Fri signal (tier 5)
    - "is_high_volume_weekday"     # CRITICAL: Binary Mon/Wed/Fri indicator (NOT SCALED - preserves on/off impact)
    - "Is_Monday"                  # CRITICAL: Monday-specific flag (NOT SCALED - preserves on/off impact)
    - "is_EOM"
    - "days_until_month_end"
    # - "mid_month_peak_tier"        # 8th-15th surge pattern
    # - "is_mid_month_peak"
    # - "days_to_mid_month_peak"
    - "early_month_low_tier"       # CRITICAL: Days 1-10 low volume signal (STRENGTHENED: -10 for days 1-5, overrides weekday_volume_tier)
    - "is_early_month_low"         # CRITICAL: Binary early month indicator (NOT SCALED - preserves on/off impact)
    - "is_first_5_days"            # CRITICAL: Days 1-5 severe drop indicator (NOT SCALED - preserves on/off impact)
    - "is_first_3_days"            # CRITICAL: Days 1-3 maximum penalty period (NOT SCALED - preserves on/off impact)
    - "days_from_month_start"      # CRITICAL: Gradient signal (0, 1, 2, 3... 30)
    - "post_peak_signal"           # SOLUTION 1: Post-Peak Decay - breaks EOM momentum (exp decay)
    - "is_high_vol_weekday_AND_early_month"  # SOLUTION 3: Explicit Interaction - STRENGTHENED: -2 for days 1-5, -1 for days 6-10 (actively suppresses weekday boost in early month, NOT SCALED)
    # NOTE: Binary interaction features (is_*) are NOT scaled by StandardScaler
    # The scaler is only applied to the target column (Total CBM), preserving the sharp on/off impact of binary flags
    # This prevents over-smoothing that would reduce their effectiveness
    # REMOVED: rolling_mean_7d, rolling_mean_30d, momentum_3d_vs_14d
    # These smooth out the weekday variations we want to capture!
    - "Total CBM"  # Historical target as feature