# MDLZ Warehouse Quantity Prediction System Configuration

# Data Configuration
data:
  data_dir: "./dataset/data_cat"  # Directory containing combined year files (data_2022.csv, data_2023.csv, etc.)
  file_pattern: "data_{year}.csv"  # Pattern for combined year files
  years: [2023, 2024, 2025]
  
  # Category selection for MVP test
  # Options:
  #   "all" - Train on all categories combined
  #   "single" - Train on one specific category (specify in category_filter)
  #   "both" - Train on all categories AND each category separately
  #   "each" - Train on each category separately (uses major_categories if specified)
  category_mode: "single"  # "all", "single", "both", or "each"
  category_filter: "DRY"  # Only used when category_mode is "single". Specify category name or null for all
  # Category behavior rules for multi-target decomposition:
  #   - major_categories: High-volume, structurally stable categories that should be modeled with the LSTM
  #                       and full entity embeddings (e.g., DRY, FRESH).
  #   - minor_categories: Low-volume / noisy categories that should be handled by simple statistical
  #                       heuristics (e.g., moving average) instead of the LSTM, to avoid corrupting
  #                       the shared hidden state.
  major_categories:
    - "DRY"
    - "FRESH"
  minor_categories:
    - "POSM"
    - "OTHER"
  # Residual / baseline configuration for scale-invariant forecasting
  # When enabled, the model is trained to predict the residual
  #   residual_t = target_col_t - baseline_col_t
  # where baseline_col_t is a causal baseline derived from historical data.
  # The baseline is then added back after inverse-scaling to recover
  # absolute Total CBM for evaluation and plotting.
  use_residual_target: false         # If true, train on residuals instead of raw target
  baseline_source_col: "rolling_mean_30d"   # Source column for baseline (must be in feature_cols)
  baseline_col: "baseline_for_target"       # Name of derived causal baseline column
  residual_col: "target_residual"           # Name of residual target column
  feature_cols:
    - "month_sin"
    - "month_cos"
    - "dayofmonth_sin"
    - "dayofmonth_cos"
    - "holiday_indicator"
    - "days_until_next_holiday"
    - "days_since_holiday"
    - "is_weekend"
    - "day_of_week_sin"
    - "day_of_week_cos"
    - "is_EOM"
    - "days_until_month_end"
    - "lunar_month"
    - "lunar_day"
    - "rolling_mean_7d"
    - "rolling_mean_30d"
    - "momentum_3d_vs_14d"
    - "Total CBM"
  
  # Target column
  target_col: "Total CBM"
  
  # Category column
  cat_col: "CATEGORY"
  cat_id_col: "CATEGORY_ID"
  time_col: "ACTUALSHIPDATE"
  
  # Data split ratios (temporal split)
  train_size: 0.7
  val_size: 0.1
  test_size: 0.2

# Window configuration
# Direct Multi-step Forecasting: Use longer context (60 days) to predict entire horizon (30 days) at once
# This prevents exposure bias from recursive forecasting where errors compound
window:
  input_size: 60  # Increased from 30 to provide more context
  horizon: 30     # Changed from 1 to 30 for direct multi-step prediction

# Model Configuration
model:
  name: "RNNWithCategory"  # or "RNNForecastor"
  num_categories: null  # Will be set dynamically from data
  cat_emb_dim: 4
  input_dim: 15  # Updated dynamically in code to match feature_cols length
  hidden_size: 128
  n_layers: 2
  output_dim: 30  # Changed from 1 to 30 to output entire forecast horizon at once (direct multi-step)
  dropout_prob: 0.2  # Only for RNNForecastor
  use_layer_norm: true  # Apply LayerNorm on final hidden state before output

# Training Configuration
training:
  batch_size: 64
  val_batch_size: 16
  test_batch_size: 16
  epochs: 20
  learning_rate: 0.001
  optimizer: "Adam"
  
  # Loss function
  loss: "MSE"  # or "spike_aware_mse"
  
  # Learning rate scheduler
  scheduler:
    name: "ReduceLROnPlateau"
    mode: "min"
    factor: 0.5
    patience: 3
    min_lr: 0.00001
  
  # Logging
  log_interval: 5  # Log every N epochs
  
  # Device
  device: "auto"  # "auto", "cuda", or "cpu"

# Output Configuration
output:
  output_dir: "../outputs"
  save_model: true
  model_dir: "../outputs/models"
  
  # Visualization
  visualize:
    save_plots: true
    show_plots: false

# Inference Configuration
inference:
  n_samples_for_plot: 100
  save_predictions: true
  
  # Category selection for prediction now reuses data.category_mode and
  # data.category_filter so train & prediction share one setting.

  # Prediction horizon (time range and data file for inference script)
  # These values are used by mvp_predict.py so you can easily change
  # which period to forecast without editing code.
  #
  # IMPORTANT: Recursive (direct multi-step) mode predicts exactly window.horizon days
  # (e.g. 30) per run, starting at prediction_start. If you set prediction_end to
  # cover a full year, only the first horizon days are produced (~1 month). Use
  # prediction_end = prediction_start + (horizon - 1) days to avoid confusion, or
  # implement rolling chunks to cover longer ranges.
  prediction_data_path: "dataset/test/data_2026.csv"  # CSV with future period to predict
  prediction_start: "2026-01-01"  # Inclusive start date (YYYY-MM-DD)
  prediction_end: "2026-01-31"    # Inclusive end date (YYYY-MM-DD); recursive mode uses first horizon days only

